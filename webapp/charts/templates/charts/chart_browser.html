{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chart Browser â€“ Global Spotify Hits</title>
    <link rel="stylesheet" href="{% static 'charts/css/top_songs.css' %}?v=2" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  </head>
  <body>
    
    {# Navigation Header #}
    {% include "charts/partials/header.html" with active_page="browser" %}

    <main class="page-container">
      <div class="content-header">
        <h1>Chart Browser</h1>
        <p class="subtitle">
          Explore the complete 2023 dataset. Filter by country, month, or search for specific artists and tracks to uncover global trends.
        </p>
      </div>

      {# Filter Controls #}
      <form method="get" class="filters" autocomplete="off">
        
        <div class="filter-field">
          <label for="country">Country</label>
          <select name="country" id="country">
            <option value="">All Countries</option>
            {% for c in countries %}
            <option value="{{ c.code }}" {% if c.code == country_query %}selected{% endif %}>
              {{ c.label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-field">
          <label for="month">Month</label>
          <select name="month" id="month">
            <option value="">All Months</option>
            {% for m in months %}
            <option value="{{ m.value }}" {% if m.value|stringformat:"s" == month_query %}selected{% endif %}>
              {{ m.label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-field" style="flex-grow: 2;">
          <label for="search">Search</label>
          <input 
            type="text" 
            id="search" 
            name="search" 
            value="{{ search_query }}" 
            placeholder="Artist or track name..." 
          />
        </div>

        <div class="filter-field" style="flex: 0 0 auto;">
          <label>&nbsp;</label> <label class="filter-checkbox" title="Show only explicit tracks">
            <input 
              type="checkbox" 
              name="explicit_only" 
              {% if explicit_only %}checked{% endif %} 
            />
            Explicit Only
          </label>
        </div>

        <div class="filter-actions">
          <button type="submit">Filter Data</button>
        </div>
      </form>

      {# Data Table Section #}
      <section class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="col-date">Date</th>
                <th class="col-country">Country</th>
                <th class="col-position">Rank</th>
                <th>Track</th>
                <th>Artist</th>
                <th class="col-streams">Streams</th>
                <th class="text-right">Explicit</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in page_obj.object_list %}
              <tr>
                <td class="col-date">{{ entry.date|date:"Y-m-d" }}</td>
                <td class="col-country">{{ entry.pretty_country }}</td>
                <td class="col-position">
                  <span class="rank-badge {% if entry.position <= 3 %}top-3{% endif %}">
                    {{ entry.position }}
                  </span>
                </td>
                <td><strong>{{ entry.track_name }}</strong></td>
                <td>{{ entry.artist }}</td>
                <td class="col-streams">{{ entry.streams }}</td>
                <td class="text-right">
                  {% if entry.explicit %}
                    <span style="color: #b3b3b3; font-size: 0.8em; border: 1px solid #b3b3b3; padding: 1px 4px; border-radius: 3px;">E</span>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="empty-message">
                  No records found matching your filters.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# Pagination Controls #}
        {% if page_obj.has_other_pages %}
        <div class="pagination">
          <div class="pagination__info">
            Showing page <strong>{{ page_obj.number }}</strong> of {{ page_obj.paginator.num_pages }}
          </div>
          <div class="pagination__links">
            
            {# Previous Link #}
            {% if page_obj.has_previous %}
              <a href="?page={{ page_obj.previous_page_number }}&country={{ country_query }}&month={{ month_query }}&search={{ search_query }}{% if explicit_only %}&explicit_only=on{% endif %}">
                &larr; Previous
              </a>
            {% else %}
              <span class="disabled">&larr; Previous</span>
            {% endif %}

            {# Next Link #}
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}&country={{ country_query }}&month={{ month_query }}&search={{ search_query }}{% if explicit_only %}&explicit_only=on{% endif %}">
                Next &rarr;
              </a>
            {% else %}
              <span class="disabled">Next &rarr;</span>
            {% endif %}
            
          </div>
        </div>
        {% endif %}
      </section>

    </main>
  </body>
</html>